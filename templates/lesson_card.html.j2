<!-- Filename: lesson_card.html.j2 -->
{# Updated: Refactored to modular structure. Removed inline activity HTML; replaced with conditional {% include %} for each activity type. Retained overall card layout, header, description, stats, actions, and comments. Moved activity-specific JS to sub-templates where possible, but kept shared global functions (e.g., submitActivity, speakQuestion) here. Adjusted classes and IDs for consistency. Preserved pulse-border, completion styling, and sequencing logic. #}

<div class="card bg-grok-surface border-2 border-blue-400 p-5 rounded-xl shadow-lg hover:-translate-y-1 hover:shadow-xl transition-all duration-200 max-w-lg mx-auto mb-6 {% if post.is_new %}pulse-border bg-blue-50/20{% endif %} {% if post.completed %}opacity-70{% endif %}" id="lesson-{{ post.lesson.id | default(post.id) }}">
    {% if post.completed %}
        <div class="flex justify-end mb-3">
            <span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center">
                <i class="fas fa-check mr-1"></i>Completed!
            </span>
        </div>
    {% endif %}
    <div class="flex items-center mb-3">
        <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3 font-bold text-sm shadow-sm">
            {{ post.lesson.subject[0] | upper if post.lesson.subject else 'L' }}
        </div>
        <div class="flex-1">
            <p class="text-grok-text font-semibold">{{ post.lesson.title | default('Untitled Lesson') }} ({{ post.handle | default('User') }})</p>
            <p class="text-grok-secondary text-sm">{{ post.created_at | default('Now') }} â€¢ {{ post.lesson.subject | default('General') | capitalize }}</p>
        </div>
    </div>
    <p class="text-grok-text mb-4 prose prose-sm max-w-none">{{ post.lesson.description | default('Dive into this interactive lesson!') | safe }}</p>
    <div class="space-y-4 mb-4">
        {% if post.lesson.trace_word %}
            {% include 'trace_activity.html.j2' %}
        {% endif %}
        {% if post.lesson.spell_word %}
            {% include 'spell_activity.html.j2' %}
        {% endif %}
        {% if post.lesson.mc_question %}
            {% include 'mc_activity.html.j2' %}
        {% endif %}
        {% if post.lesson.sentence_question %}
            {% include 'sentence_activity.html.j2' %}
        {% endif %}
        {% if post.lesson.math_question %}
            {% include 'math_activity.html.j2' %}
        {% endif %}
        {% if post.lesson.sound %}
            {% include 'sound_activity.html.j2' %}
        {% endif %}
    </div>
    <div class="flex justify-between text-grok-secondary mb-4 text-xs">
        <span> {{ post.views or 0 }} views</span>
        <span> {{ post.likes or 0 }} likes</span>
        <span> {{ (comments[post.id] | length) if post.id in comments else 0 }} notes</span>
    </div>
    <div class="flex justify-between border-t border-blue-300 pt-3 text-sm">
        <button onclick="window.likePost({{ post.id }})" class="text-grok-text hover:text-blue-500 flex items-center {% if post.liked_by_user %}text-blue-500{% endif %}">
            <i class="fas fa-heart mr-1"></i>{{ 'Unlike' if post.liked_by_user else 'Like' }}
        </button>
        <button onclick="window.toggleComments({{ post.id }})" class="text-grok-text hover:text-blue-500 flex items-center">
            <i class="fas fa-comment mr-1"></i>Notes
        </button>
        <button class="text-grok-text flex items-center opacity-50 cursor-not-allowed" disabled>
            <i class="fas fa-share mr-1"></i>Share
        </button>
    </div>
    <div id="comment-form-{{ post.id }}" style="display: none;" class="mt-3">
        <form method="POST" action="/comment/{{ post.id }}">
            <textarea name="content" placeholder="Add a note..." class="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white text-gray-900" required rows="2"></textarea>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 mt-2">Post Note</button>
        </form>
    </div>
    {% if post.id in comments %}
        <div class="mt-4">
            <h4 class="text-sm font-semibold text-grok-text mb-2">Notes:</h4>
            {% for comment in (comments[post.id] | sort(attribute='created_at'))[:3] %}
                <div class="border-l-2 border-blue-400 pl-4 mb-2 text-sm">
                    <strong class="text-grok-text">{{ comment.handle | default('Anon') }}</strong> - <small class="text-grok-secondary">{{ comment.created_at }}</small>
                    <p>{{ comment.content | safe }}</p>
                </div>
            {% endfor %}
            {% if (comments[post.id] | length) > 3 %}
                <div id="hidden-comments-{{ post.id }}" style="display: none;">
                    {% for comment in comments[post.id] | slice(3) %}
                        <div class="border-l-2 border-blue-400 pl-4 mb-2 text-sm">
                            <strong class="text-grok-text">{{ comment.handle | default('Anon') }}</strong> - <small class="text-grok-secondary">{{ comment.created_at }}</small>
                            <p>{{ comment.content | safe }}</p>
                        </div>
                    {% endfor %}
                </div>
                <button id="toggle-btn-{{ post.id }}" onclick="window.toggleCommentsExtra({{ post.id }})" class="text-blue-500 underline text-sm">Show more ({{ (comments[post.id] | length) - 3 }} more)</button>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
if (!window.activityOrder) {
  window.activityOrder = ['trace', 'spell', 'mc', 'sentence', 'math', 'sound'];
}

if (!window.initAllActivities) {
  window.initAllActivities = function() {
    document.querySelectorAll('.card[id^="lesson-"]').forEach(card => {
      const lessonId = card.id.split('-')[1];
      if (document.getElementById(`lesson-${lessonId}`).classList.contains('opacity-70')) return; // Skip completed lessons
      const sections = Array.from(card.querySelectorAll('.activity-section')).filter(s => window.activityOrder.includes(s.dataset.type));
      sections.slice(1).forEach(section => {
        section.classList.add('disabled-activity');
        section.querySelectorAll('input, button, canvas').forEach(el => el.disabled = true);
      });
      if (sections.length > 0) {
        sections[0].classList.remove('disabled-activity');
        sections[0].querySelectorAll('input, button, canvas').forEach(el => el.disabled = false);
        if (sections[0].dataset.type === 'trace') window.initCanvas(lessonId);
      }
    });
  }
}

if (!window.enableNextActivity) {
  window.enableNextActivity = function(lessonId, currentType) {
    const card = document.getElementById(`lesson-${lessonId}`);
    if (card.classList.contains('opacity-70')) return; // Already completed
    const sections = Array.from(card.querySelectorAll('.activity-section')).filter(s => window.activityOrder.includes(s.dataset.type));
    const currentIndex = sections.findIndex(s => s.dataset.type === currentType);
    if (currentIndex < 0 || currentIndex >= sections.length - 1) return; // No next or last
    const nextSection = sections[currentIndex + 1];
    nextSection.classList.remove('disabled-activity');
    nextSection.querySelectorAll('input, button, canvas').forEach(el => el.disabled = false);
    if (nextSection.dataset.type === 'trace') window.initCanvas(lessonId);
  }
}

if (!window.initCanvas) {
  window.initCanvas = function(lessonId) {
    const canvas = document.getElementById(`trace-canvas-${lessonId}`);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#000';
    let drawing = false;

    function startDrawing(e) {
      drawing = true;
      const { x, y } = getCoordinates(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
      // Removed preventDefault from touchstart to allow scroll initiation; handle in touchmove only when drawing
      if (e.type === 'touchstart') e.preventDefault();
    }

    function draw(e) {
      if (!drawing) return;
      const { x, y } = getCoordinates(e);
      ctx.lineTo(x, y);
      ctx.stroke();
      if (e.type === 'touchmove') e.preventDefault(); // Prevent scroll only while actively drawing
    }

    function endDrawing(e) {
      drawing = false;
      if (e.type === 'touchend') e.preventDefault();
    }

    function getCoordinates(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }

    // Mouse events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDrawing);
    canvas.addEventListener('mouseout', endDrawing);

    // Touch events
    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', endDrawing, { passive: false });
    canvas.addEventListener('touchcancel', endDrawing, { passive: false });
  }
}

if (!window.clearCanvas) {
  window.clearCanvas = function(canvasId) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
}

if (!window.playClickSound) {
  window.playClickSound = function() {
    if (typeof AudioContext !== 'undefined') {
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.1);
      } catch (e) {
        console.warn('Click sound failed:', e);
      }
    }
  }
}

if (!window.playAudio) {
  window.playAudio = function(word) {
    if ('speechSynthesis' in window) {
      try {
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.onerror = function(e) {
          console.warn('TTS error:', e);
        };
        speechSynthesis.speak(utterance);
      } catch (e) {
        console.warn('TTS failed:', e);
      }
    } else {
      console.warn('TTS not supported');
    }
  }
}

if (!window.speakQuestion) {
  window.speakQuestion = function(text, btn) {
    if (btn.disabled) return;
    if ('speechSynthesis' in window) {
      try {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.onerror = function(e) {
          console.warn('TTS error:', e);
        };
        speechSynthesis.speak(utterance);
      } catch (e) {
        console.warn('TTS failed:', e);
      }
    } else {
      console.warn('TTS not supported');
    }
  }
}

if (!window.selectMcOption) {
  window.selectMcOption = function(lessonId, btn, value, type = 'mc') {
    const section = document.querySelector(`#lesson-${lessonId} .activity-section[data-type="${type}"]`);
    if (section.classList.contains('disabled-activity')) return;
    const buttons = section.querySelectorAll('.mc-btn');
    buttons.forEach(b => {
      b.classList.remove('selected');
      b.style.backgroundColor = '';
      b.style.color = '';
    });
    btn.classList.add('selected');
    btn.style.backgroundColor = '#3b82f6';
    btn.style.color = 'white';
    const hiddenId = `${type}-hidden-${lessonId}`;
    const hidden = document.getElementById(hiddenId);
    if (hidden) hidden.value = value;
    window.playClickSound();
    window.playAudio(value.toLowerCase());
  }
}

if (!window.submitActivity) {
  window.submitActivity = function(event, lessonId, activityType) {
    console.log(`submitActivity called for lesson ${lessonId}, activity ${activityType}`);
    if (!lessonId) {
      console.error('Missing lessonId');
      alert('Error: Missing lesson ID. Please reload.');
      return;
    }
    if (!activityType) {
      console.error('Missing activityType');
      alert('Error: Missing activity type. Please reload.');
      return;
    }
    if (document.getElementById(`lesson-${lessonId}`).classList.contains('opacity-70')) {
      console.log(`Lesson ${lessonId} is completed, exiting`);
      return;
    }
    const section = document.querySelector(`#lesson-${lessonId} .activity-section[data-type="${activityType}"]`);
    if (!section) {
      console.error(`No section found for activity ${activityType}`);
      alert('Error: Activity not found!');
      return;
    }
    if (section.classList.contains('disabled-activity')) {
      console.log(`Activity ${activityType} is disabled, skipping`);
      return;
    }
    const btn = section.querySelector('.check-btn');
    let answer = '';
    if (activityType === 'trace') {
      answer = 'drawn'; // Mark as drawn by default
    } else if (activityType === 'spell' || activityType === 'math' || activityType === 'sound') {
      answer = section.querySelector('input[type="text"]')?.value || '';
    } else if (activityType === 'mc' || activityType === 'sentence') {
      const hiddenId = `${activityType}-hidden-${lessonId}`;
      const hidden = document.getElementById(hiddenId);
      answer = hidden ? hidden.value : '';
    }
    if (!answer.trim()) {
      console.log(`No valid answer for ${activityType}`);
      alert('Please select or enter an answer!');
      return;
    }
    const payload = { lesson_id: lessonId, activity_type: activityType, answer };
    console.log(`Sending to /check_lesson:`, payload);
    fetch('/check_lesson', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    })
    .then(r => {
      console.log(`Response status: ${r.status}`);
      if (!r.ok) {
        return r.text().then(text => { throw new Error(`HTTP ${r.status}: ${text}`); });
      }
      return r.json();
    })
    .then(d => {
      console.log('Response data:', d);
      if (d.success) {
        const msg = d.correct ? `Correct! +${d.points} points ` : 'Try again! ';
        alert(msg);
        if (d.correct) {
          section.style.backgroundColor = '#dbeafe';
          btn.textContent = 'Done! ';
          btn.disabled = true;
          window.enableNextActivity(lessonId, activityType);
          if (d.lesson_completed) {
            document.getElementById(`lesson-${lessonId}`).classList.add('opacity-70');
            document.getElementById(`lesson-${lessonId}`).querySelectorAll('.check-btn, input, canvas').forEach(el => el.disabled = true);
          }
        }
      } else {
        alert(d.error || 'Check failed');
      }
    })
    .catch(e => {
      console.error('Submit error:', e);
      alert(`Oopsâ€”${e.message}. Reload and try again!`);
    });
  }
}

if (!window.likePost) {
  window.likePost = function(postId) {
    console.log(`likePost called for post ${postId}`);
    fetch(`/like/${postId}`, {method: 'POST'})
      .then(r => r.json())
      .then(d => {
        if (d.success) location.reload();
        else alert(d.error);
      })
      .catch(e => console.error('Like error:', e));
  }
}

if (!window.toggleComments) {
  window.toggleComments = function(postId) {
    console.log(`toggleComments called for post ${postId}`);
    const form = document.getElementById(`comment-form-${postId}`);
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  }
}

if (!window.toggleCommentsExtra) {
  window.toggleCommentsExtra = function(postId) {
    console.log(`toggleCommentsExtra called for post ${postId}`);
    const hidden = document.getElementById(`hidden-comments-${postId}`);
    const btn = document.getElementById(`toggle-btn-${postId}`);
    if (hidden.style.display === 'none') {
      hidden.style.display = 'block';
      btn.textContent = 'Show less';
    } else {
      hidden.style.display = 'none';
      btn.textContent = `Show more (${hidden.children.length} more)`;
    }
  }
}

document.addEventListener('DOMContentLoaded', window.initAllActivities);
</script>

<style>
.pulse-border { 
    position: relative; 
    border: 2px solid transparent; 
    border-radius: 0.75rem;
    box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
    animation: pulse 4s linear infinite;
}
@keyframes pulse { 
    0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 
    70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 
    100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } 
}

@media (max-width: 640px) {
  canvas[id^="trace-canvas-"] {
    width: 100% !important;
    height: 150px !important;
  }
}

.disabled-activity {
    opacity: 0.5;
    pointer-events: none;
}

.mc-btn.selected {
  background-color: #3b82f6 !important;
  color: white !important;
  border-color: #3b82f6 !important;
}
</style>