{% extends 'base.html.j2' %}
{% block title %}Home - EduGrok{% endblock %}
{% block content %}
<div class="container mx-auto p-4">
    <!-- Welcome Message -->
    <div class="bg-white dark:bg-gray-700 p-4 mb-6 rounded shadow">
        <h2 class="text-xl font-semibold">Welcome, {{ session.get('email', 'Guest') }}!</h2>
        {% if subscribed %}
            <p class="text-green-600 dark:text-green-300 mt-2">Subscribed to Premium</p>
        {% endif %}
        <div class="mt-4">
            <a href="{{ url_for('phonics_game') }}" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Play Phonics Game</a>
        </div>
    </div>

    <!-- Create Post Form -->
    <div class="bg-white dark:bg-gray-700 p-4 mb-6 rounded shadow">
        <h2 class="text-xl font-semibold mb-2">Create a Post</h2>
        <form action="{{ url_for('create_post') }}" method="POST">
            <textarea name="content" class="w-full p-2 border rounded bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100" rows="4" placeholder="What's on your mind?"></textarea>
            <input type="text" name="subject" class="w-full p-2 mt-2 border rounded bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100" placeholder="Subject (e.g., Math, Phonics)">
            <button type="submit" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Post</button>
        </form>
    </div>

    <!-- Active Lesson -->
    {% if lesson and not lesson.completed %}
        <div class="bg-white dark:bg-gray-700 p-4 mb-4 rounded shadow">
            <h2 class="text-xl font-semibold">{{ lesson.subject }}</h2>
            <div class="mt-2">{{ lesson.content|safe }}</div>
            <button onclick="completeLesson('{{ lesson.id }}')" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Complete Lesson</button>
        </div>
    {% endif %}

    <!-- Recent Test -->
    {% if test %}
        <div class="bg-white dark:bg-gray-700 p-4 mb-4 rounded shadow">
            <h2 class="text-xl font-semibold">Latest Test</h2>
            <p>Grade: {{ test.grade }}, Score: {{ test.score }}, Date: {{ test.date }}</p>
        </div>
    {% endif %}

    <!-- Feed of Posts -->
    <div class="space-y-4">
        {% if posts %}
            {% for post in posts %}
                <div class="bg-white dark:bg-gray-700 p-4 rounded shadow transform transition hover:scale-105">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">{{ post.handle }}</span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">{{ post.subject }}</span>
                    </div>
                    <p class="mb-2">{{ post.content|safe }}</p>
                    <div class="flex space-x-4">
                        <button onclick="likePost('{{ post.id }}')" class="flex items-center {% if post.liked_by_user %}text-red-500{% else %}text-gray-500{% endif %} hover:text-red-600">
                            ‚ù§Ô∏è <span id="likes-{{ post.id }}" class="ml-1">{{ post.likes|default(0) }}</span>
                        </button>
                        <button onclick="reportPost('{{ post.id }}')" class="text-gray-500 hover:text-yellow-500">
                            üö© Report
                        </button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-red-500">Failed to load feed. Please try again.</p>
            <script>console.error('No posts loaded - check server logs');</script>
        {% endif %}
    </div>
</div>
<script>
function likePost(postId) {
    fetch('/like/' + postId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
        .then(function(response) {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Error liking post');
        })
        .then(function(data) {
            if (data.success) {
                document.getElementById('likes-' + postId).textContent = parseInt(document.getElementById('likes-' + postId).textContent) + 1;
                document.querySelector(`button[onclick="likePost('${postId}')"]`).classList.add('text-red-500');
                document.querySelector(`button[onclick="likePost('${postId}')"]`).classList.remove('text-gray-500');
            } else {
                alert('Error liking post');
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            alert('Error liking post');
        });
}

function reportPost(postId) {
    fetch('/report/' + postId, { method: 'GET' })
        .then(function(response) {
            if (response.redirected) {
                window.location.reload();
            } else {
                alert('Error reporting post');
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
        });
}

function completeLesson(lessonId) {
    fetch('/complete_lesson/' + lessonId, { method: 'GET' })
        .then(function(response) {
            if (response.redirected) {
                window.location.reload();
            } else {
                alert('Error completing lesson');
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
        });
}
</script>
{% endblock %}