<!-- home.html.j2 -->
{% extends "base.html.j2" %}

{% block content %}

{% include "post_form.html.j2" %}

{% if posts %}
    {% include "posts.html.j2" %}
{% else %}
    <div class="text-center py-8">
        <p class="text-gray-600 text-lg">No posts available yet. Be the first to share!</p>
    </div>
{% endif %}

{% if lesson %}
    {% include "lesson_card.html.j2" %}
{% else %}
    <div class="text-center py-8">
        <p class="text-gray-600 text-lg">No lessons available. Try generating a new one!</p>
    </div>
{% endif %}

{% include "game_card.html.j2" %}

{% include "recent_test.html.j2" %}

<script>
// Shared JS for post form (modal toggle, media preview, char count) - kept in home for global access
document.addEventListener('DOMContentLoaded', function() {
    const openButton = document.getElementById('open-post-form');
    const closeButton = document.getElementById('close-post-form');
    const cancelButton = document.getElementById('cancel-post');
    const postForm = document.getElementById('post-form');
    const backdrop = document.getElementById('post-form-backdrop');

    if (!openButton || !postForm || !backdrop) {
        console.error('Required elements not found for post form toggle');
        return;
    }

    openButton.addEventListener('click', function() {
        postForm.classList.remove('hidden');
        backdrop.classList.remove('hidden');
        setTimeout(() => {
            postForm.classList.remove('scale-95');
            postForm.classList.add('scale-100');
        }, 10);
    });

    function closePostForm() {
        postForm.classList.add('scale-95');
        setTimeout(() => {
            postForm.classList.remove('scale-100');
            postForm.classList.add('hidden');
            backdrop.classList.add('hidden');
        }, 200);
    }

    closeButton.addEventListener('click', closePostForm);
    if (cancelButton) {
        cancelButton.addEventListener('click', closePostForm);
    }
    backdrop.addEventListener('click', function(e) {
        if (e.target === backdrop) {
            closePostForm();
        }
    });

    // Media preview
    const mediaUpload = document.getElementById('media-upload');
    if (mediaUpload) {
        mediaUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const preview = document.getElementById('media-preview');
            preview.innerHTML = ''; // Clear previous preview
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.maxWidth = '100%';
                img.style.maxHeight = '300px';
                img.style.objectFit = 'contain';
                img.style.borderRadius = '8px';
                preview.appendChild(img);
            } else if (file.type === 'video/mp4') {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '300px';
                video.style.objectFit = 'contain';
                video.style.borderRadius = '8px';
                preview.appendChild(video);
            }
        });
    }

    // Character count
    const postContent = document.getElementById('post-content');
    if (postContent) {
        postContent.addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('char-count').textContent = `${count}/280`;
        });
    }
});
</script>

{% endblock %}