<!-- Filename: post_card.html.j2 -->
<!-- Updates: Changed bg-grok-surface-light to #5b5b66 for darker gray background. Fixed sparkly border to ensure rounded corners using pseudo-element with rounded-xl (border-radius: 0.75rem). Maintained theme consistency with grok- classes. Ensured responsiveness and transitions. -->

<div class="card bg-grok-surface {% if post.is_new %}bg-grok-surface-light sparkly-border{% else %}border-grok-border{% endif %} p-5 rounded-xl shadow-lg border hover:-translate-y-1 hover:shadow-xl transition-all duration-200 max-w-lg mx-auto mb-6" id="post-{{ post.id }}">
    <!-- Post Header -->
    <div class="flex items-center mb-3">
        <div class="flex-1">
            <p class="text-grok-text font-semibold">{{ post.handle }}{% if post.original_handle %} (reposted from {{ post.original_handle }}){% endif %}</p>
            <p class="text-grok-secondary text-sm">{{ post.created_at }}</p>
        </div>
    </div>

    <!-- Post Content -->
    <p class="text-grok-text mb-4 prose prose-sm max-w-none">{{ post.content | safe }}</p>
    {% if post.media_url %}
        {% if post.media_url.endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
            <img src="{{ post.media_url }}" alt="Post media" class="max-w-full h-auto rounded-lg shadow-md mb-4">
        {% elif post.media_url.endswith('.mp4') %}
            <video src="{{ post.media_url }}" controls class="max-w-full h-auto rounded-lg shadow-md mb-4"></video>
        {% endif %}
    {% endif %}

    <!-- Post Stats -->
    <div class="flex justify-between text-grok-secondary mb-4" style="font-size:70%;">
        <span><i class="fas fa-eye mr-1"></i>{{ post.views }} Views</span>
        <span><i class="fas fa-heart mr-1"></i>{{ post.likes }} Likes</span>
        <span><i class="fas fa-retweet mr-1"></i>{{ post.reposts }} Reposts</span>
        <span><i class="fas fa-comment mr-1"></i>{{ comments[post.id] | length if comments[post.id] else 0 }} Comments</span>
    </div>

    <!-- Post Actions -->
    <div class="flex justify-between border-t border-grok-border pt-3" style="font-size:80%;">
        <button onclick="likePost({{ post.id }})" class="text-grok-text hover:text-grok-accent transition flex items-center {% if post.liked_by_user %}text-red-500{% endif %}">
            <i class="fas fa-heart mr-1"></i> {% if post.liked_by_user %}Unlike{% else %}Like{% endif %}
        </button>
        <button onclick="repostPost({{ post.id }})" class="text-grok-text hover:text-grok-accent transition flex items-center {% if post.reposted_by_user %}text-green-500{% endif %}">
            <i class="fas fa-retweet mr-1"></i> {% if post.reposted_by_user %}Unrepost{% else %}Repost{% endif %}
        </button>
        <button onclick="toggleComments({{ post.id }})" class="text-grok-text hover:text-grok-accent transition flex items-center">
            <i class="fas fa-comment mr-1"></i> Comment
        </button>
        <button onclick="sharePost({{ post.id }})" class="text-grok-text hover:text-grok-accent transition flex items-center">
            <i class="fas fa-share mr-1"></i> Share
        </button>
    </div>

    <!-- Comment Form -->
    <form id="comment-form-{{ post.id }}" style="display: none;" method="POST" action="{{ url_for('add_comment', post_id=post.id) }}" class="mt-4">
        <textarea name="content" class="w-full p-3 border border-grok-border rounded-lg bg-grok-bg text-grok-text focus:outline-none focus:ring-2 focus:ring-grok-accent" rows="3" placeholder="Add a comment..." required></textarea>
        <button type="submit" class="mt-2 bg-grok-accent text-grok-text px-4 py-2 rounded-md hover:bg-grok-accent-hover transition">Post Comment</button>
    </form>

    <!-- Comments -->
    {% if comments[post.id] %}
        <div class="mt-4">
            {% set comment_count = comments[post.id] | length %}
            {% for comment in comments[post.id] | sort(attribute='created_at') %}
                {% if loop.index <= 2 %}
                    <div class="border-l-2 border-grok-accent pl-4 mb-2">
                        <p class="text-grok-text font-semibold">{{ comment.handle }}</p>
                        <p class="text-grok-secondary text-sm">{{ comment.created_at }}</p>
                        <p class="text-grok-text">{{ comment.content }}</p>
                    </div>
                {% else %}
                    <div id="hidden-comments-{{ post.id }}" style="display: none;">
                        <div class="border-l-2 border-grok-accent pl-4 mb-2">
                            <p class="text-grok-text font-semibold">{{ comment.handle }}</p>
                            <p class="text-grok-secondary text-sm">{{ comment.created_at }}</p>
                            <p class="text-grok-text">{{ comment.content }}</p>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            {% if comment_count > 2 %}
                <button id="toggle-btn-{{ post.id }}" onclick="toggleCommentsExtra({{ post.id }})" class="text-grok-accent hover:underline mt-2">
                    Show more ({{ comment_count - 2 }} more)
                </button>
            {% endif %}
        </div>
    {% endif %}
</div>

<style>
/* Sparkly border effect for new posts with rounded corners using pseudo-element */
.sparkly-border {
    position: relative;
    border: 2px solid transparent;
    border-radius: 0.75rem; /* Matches rounded-xl */
}
.sparkly-border::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border-radius: 0.75rem; /* Matches rounded-xl */
    background-size: 400%;
    animation: sparkle 5s linear infinite;
    z-index: -1;
}

/* Dark gray background for new posts */
.bg-grok-surface-light {
    background-color: #000000ff; /* Dark gray as specified */
}

@keyframes sparkle {
    0% { background-position: 0% 50%; }
    100% { background-position: 400% 50%; }
}
</style>