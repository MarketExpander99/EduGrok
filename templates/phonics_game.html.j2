{% extends 'base.html.j2' %}
{% block title %}Phonics Game - EduGrok{% endblock %}
{% block content %}
<div class="container p-4">
  <h1 class="display-4 font-weight-bold mb-4 text-center pirate-text">Mars Memory Match: Phonics Pirate Raid</h1>
  <h2 id="timer" class="h3 font-weight-bold text-center mb-4 text-success">Time: 30s</h2>
  <p class="text-center mb-4 lead">Match the M-sound words before the space pirates steal them!</p>
  <div id="taunt" class="text-center mb-4 text-danger d-none"></div>
  <div class="row justify-content-center">
    {% for word in ['moon', 'mars', 'mug', 'mat', 'moon', 'mars', 'mug', 'mat'] %}
      <div class="col-6 col-md-3 mb-3">
        <div class="card h-100 text-center border-0 shadow-sm game-input transform-transition" 
             data-word="{{ word }}" 
             onclick="flipCard(this)"
             style="cursor: pointer; transition: transform 0.3s ease-in-out;">
          <div class="card-body p-4">
            <span class="front d-block text-xl font-weight-bold">{{ word }}</span>
            <span class="back d-none text-xl font-weight-bold">?</span>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
<script>
const taunts = [
  "Argh, ye missed me treasure!",
  "Shiver me timbers, try again!",
  "Ye'll never catch me words!"
];
let flippedCards = [];
let matchedPairs = 0;
let timeLeft = 30;
let timerId = null;
const timerDisplay = document.getElementById('timer');
const tauntDisplay = document.getElementById('taunt');

function startTimer() {
  timerId = setInterval(() => {
    timeLeft--;
    timerDisplay.textContent = `Time: ${timeLeft}s`;
    timerDisplay.className = `h3 font-weight-bold text-center mb-4 ${timeLeft <= 10 ? 'text-danger' : 'text-success'}`;
    if (timeLeft <= 0) {
      clearInterval(timerId);
      alert("Time's up! The pirates stole your words!");
      document.querySelectorAll('.game-input').forEach(input => input.style.cursor = 'not-allowed');
      document.querySelectorAll('.card').forEach(card => card.onclick = null);
    }
  }, 1000);
}

function flipCard(card) {
  if (timeLeft <= 0 || flippedCards.length >= 2 || card.classList.contains('matched')) return;
  card.classList.add('rotate-y-180');
  card.querySelector('.front').classList.add('d-none');
  card.querySelector('.back').classList.remove('d-none');
  flippedCards.push(card);
  if (flippedCards.length === 2) {
    const [card1, card2] = flippedCards;
    if (card1.dataset.word === card2.dataset.word) {
      card1.classList.add('matched', 'bg-success', 'text-white');
      card2.classList.add('matched', 'bg-success', 'text-white');
      matchedPairs++;
      if (matchedPairs === 4) {
        completeGame();
      }
    } else {
      tauntDisplay.textContent = taunts[Math.floor(Math.random() * taunts.length)];
      tauntDisplay.classList.remove('d-none');
      setTimeout(() => {
        card1.classList.remove('rotate-y-180');
        card2.classList.remove('rotate-y-180');
        card1.querySelector('.front').classList.remove('d-none');
        card1.querySelector('.back').classList.add('d-none');
        card2.querySelector('.front').classList.remove('d-none');
        card2.querySelector('.back').classList.add('d-none');
        tauntDisplay.classList.add('d-none');
      }, 1000);
    }
    flippedCards = [];
  }
}

function completeGame() {
  if (timeLeft > 0) {
    clearInterval(timerId);
    fetch('/update_coins', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ coins: 5 })
    }).then(response => response.json()).then(data => {
      if (data.success) {
        alert('You beat the pirates! +5 Star Coins');
        window.location.href = '/profile';
      } else {
        alert('Failed to award coins: ' + (data.error || 'Unknown error'));
      }
    }).catch(error => {
      alert('Error completing game');
      console.error(error);
    });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  startTimer();
  const cards = document.querySelectorAll('.card');
  const shuffled = [...cards].sort(() => Math.random() - 0.5);
  const container = document.querySelector('.row');
  container.innerHTML = '';
  shuffled.forEach(card => container.appendChild(card));
});
</script>
<style>
.card { transition: transform 0.3s; }
.card.matched { pointer-events: none; }
.rotate-y-180 { transform: rotateY(180deg); }
.transform-transition { /* Fallback for smoother hovers if needed */ }
</style>
{% endblock %}